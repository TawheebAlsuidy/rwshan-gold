{% extends 'base.html' %}
{% load i18n static %}

{% block title %}{% trans "Customize Your Uniform - Rwshan Gold Company" %}{% endblock %}

{% block content %}
<div class="container py-8">
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="configurator-steps mb-5">
            <div class="step completed">
                <div class="step-number">1</div>
                <div class="step-title">{% trans "Select Category" %}</div>
            </div>
            <div class="step active">
                <div class="step-number">2</div>
                <div class="step-title">{% trans "Customize Design" %}</div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-title">{% trans "Preview & Save" %}</div>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <h2 class="card-title">{% trans "Customize Your Uniform" %}</h2>
                <form method="post" enctype="multipart/form-data" id="design-form">
                    {% csrf_token %}
                    
                    <!-- الحقول كما هي -->
                    <div class="mb-3">
                        <label for="{{ form.product.id_for_label }}" class="form-label">{% trans "Product" %}</label>
                        {{ form.product }}
                        {% if form.product.errors %}
                        <div class="text-danger">
                            {{ form.product.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.fabric.id_for_label }}" class="form-label">{% trans "Fabric" %}</label>
                        {{ form.fabric }}
                        {% if form.fabric.errors %}
                        <div class="text-danger">
                            {{ form.fabric.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Color Picker Section -->
                    <div class="mb-3">
                        <label for="{{ form.color.id_for_label }}" class="form-label">{% trans "Choose Color" %}</label>
                        <div class="d-flex align-items-center gap-3">
                            {{ form.color }}
                            <div id="color-preview" class="border rounded" style="width: 40px; height: 40px; background-color: {{ form.color.value|default:'#000000' }};"></div>
                            <input type="text" id="color-hex" class="form-control" style="max-width: 120px;" 
                                    value="{{ form.color.value|default:'#000000' }}" readonly>
                            <span id="color-name" class="badge bg-secondary"></span>
                        </div>
                        {% if form.color.errors %}
                        <div class="text-danger">
                            {{ form.color.errors }}
                        </div>
                        {% endif %}
                        <div class="form-text">{% trans "Click the color box to choose your preferred color" %}</div>
                    </div>
                    
                    <!-- Popular Colors -->
                    <div class="mb-3">
                        <label class="form-label">{% trans "Popular Colors" %}</label>
                        <div class="d-flex flex-wrap gap-2 mb-2">
                            <!-- الألوان كما هي -->
                            <button type="button" class="btn color-preset" data-color="#000000" data-name="أسود" style="background-color: #000000; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#FFFFFF" data-name="أبيض" style="background-color: #FFFFFF; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#2E5AAC" data-name="أزرق" style="background-color: #2E5AAC; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#228B22" data-name="أخضر" style="background-color: #228B22; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#8B0000" data-name="أحمر" style="background-color: #8B0000; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#FFD700" data-name="ذهبي" style="background-color: #FFD700; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#808080" data-name="رمادي" style="background-color: #808080; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#A0522D" data-name="بني" style="background-color: #A0522D; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn color-preset" data-color="#87CEEB" data-name="أزرق سماوي" style="background-color: #87CEEB; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#556B2F" data-name="زيتي" style="background-color: #556B2F; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#F5F5DC" data-name="بيج" style="background-color: #F5F5DC; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#000080" data-name="كحلي" style="background-color: #000080; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#FFA500" data-name="برتقالي" style="background-color: #FFA500; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#FFFF00" data-name="أصفر" style="background-color: #FFFF00; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#FFC0CB" data-name="وردي" style="background-color: #FFC0CB; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                            <button type="button" class="btn color-preset" data-color="#800080" data-name="بنفسجي" style="background-color: #800080; width: 30px; height: 30px; border: 2px solid #dee2e6;"></button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.logo.id_for_label }}" class="form-label">{% trans "Upload Logo (Optional)" %}</label>
                        {{ form.logo }}
                        {% if form.logo.errors %}
                        <div class="text-danger">
                            {{ form.logo.errors }}
                        </div>
                        {% endif %}
                        <div class="form-text">{% trans "Upload your company logo to be placed on the uniform" %}</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">{% trans "Additional Notes (Optional)" %}</label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="text-danger">
                            {{ form.notes.errors }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'configurator:start' %}" class="btn btn-outline-secondary">{% trans "Back" %}</a>
                        <button type="submit" class="btn btn-primary" id="submit-btn">
                            {% trans "Continue to Preview" %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
        <div class="modal-body text-center py-5">
            <!-- Animated Spinner -->
            <div class="loading-spinner mb-4">
                <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                    <span class="visually-hidden">{% trans "Loading..." %}</span>
                </div>
            </div>
            
            <!-- Loading Text -->
            <h4 class="text-primary mb-3">{% trans "جاري إنشاء تصميم زيك" %}</h4>
            <p class="text-muted mb-4">{% trans "نعمل على تصميم الزي الخاص بك باستخدام الذكاء الاصطناعي" %}</p>
            
            <!-- Progress Bar -->
            <div class="progress mb-3" style="height: 6px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
            </div>
            
            <!-- Estimated Time -->
            <small class="text-muted">{% trans "قد يستغرق هذا بضع ثوانٍ..." %}</small>
            
            <!-- Decorative Elements -->
            <div class="mt-4">
                <div class="d-flex justify-content-center gap-2">
                    <div class="p-2 bg-primary bg-opacity-10 rounded">
                        <i class="fas fa-tshirt text-primary"></i>
                    </div>
                    <div class="p-2 bg-success bg-opacity-10 rounded">
                        <i class="fas fa-palette text-success"></i>
                    </div>
                    <div class="p-2 bg-warning bg-opacity-10 rounded">
                        <i class="fas fa-magic text-warning"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
const colorInput = document.getElementById('{{ form.color.id_for_label }}');
const colorPreview = document.getElementById('color-preview');
const colorHex = document.getElementById('color-hex');
const colorName = document.getElementById('color-name');
const colorPresets = document.querySelectorAll('.color-preset');
const designForm = document.getElementById('design-form');
const submitBtn = document.getElementById('submit-btn');
const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));

// دالة لتحديث اسم اللون بناءً على الكود
function updateColorName(hexCode) {
    const colorNames = {
        '#000000': 'أسود',
        '#FFFFFF': 'أبيض',
        '#2E5AAC': 'أزرق',
        '#228B22': 'أخضر',
        '#8B0000': 'أحمر',
        '#FFD700': 'ذهبي',
        '#808080': 'رمادي',
        '#A0522D': 'بني',
        '#87CEEB': 'أزرق سماوي',
        '#556B2F': 'زيتي',
        '#F5F5DC': 'بيج',
        '#000080': 'كحلي',
        '#FFA500': 'برتقالي',
        '#FFFF00': 'أصفر',
        '#FFC0CB': 'وردي',
        '#800080': 'بنفسجي'
    };
    
    const name = colorNames[hexCode.toUpperCase()];
    if (name) {
        colorName.textContent = name;
        colorName.className = 'badge bg-primary';
    } else {
        colorName.textContent = 'لون مخصص';
        colorName.className = 'badge bg-secondary';
    }
}

// تحديث المعاينة واسم اللون عند تغيير اللون
colorInput.addEventListener('input', function() {
    colorPreview.style.backgroundColor = this.value;
    colorHex.value = this.value;
    updateColorName(this.value);
});

// إضافة مستمع للألوان الشائعة
colorPresets.forEach(preset => {
    preset.addEventListener('click', function() {
        const color = this.getAttribute('data-color');
        const name = this.getAttribute('data-name');
        
        colorInput.value = color;
        colorPreview.style.backgroundColor = color;
        colorHex.value = color;
        colorName.textContent = name;
        colorName.className = 'badge bg-primary';
    });
});

// تحديث اسم اللون الأولي عند تحميل الصفحة
updateColorName(colorInput.value);

// إدارة إرسال النموذج وعرض شاشة الانتظار
designForm.addEventListener('submit', function(e) {
    // التحقق من صحة النموذج أولاً
    if (!this.checkValidity()) {
        return; // إذا لم يكن النموذج صالحاً، اترك التحقق الافتراضي يعمل
    }
    
    // منع الإرسال المباشر وعرض شاشة الانتظار
    e.preventDefault();
    
    // تعطيل زر الإرسال لمنع النقر المتعدد
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>{% trans "جاري المعالجة..." %}';
    
    // عرض شاشة الانتظار
    loadingModal.show();
    
    // إرسال النموذج بعد تأخير بسيط لضمان عرض الشاشة
    setTimeout(() => {
        this.submit();
    }, 500);
});
});
</script>

<style>
.form-control-color {
padding: 0;
border: 1px solid #dee2e6;
border-radius: 0.375rem;
cursor: pointer;
}

.color-preset {
transition: transform 0.2s ease;
position: relative;
}

.color-preset:hover {
transform: scale(1.1);
border-color: #007bff !important;
}

.color-preset:hover::after {
content: attr(data-name);
position: absolute;
bottom: -25px;
left: 50%;
transform: translateX(-50%);
background: #333;
color: white;
padding: 2px 6px;
border-radius: 3px;
font-size: 10px;
white-space: nowrap;
z-index: 10;
}

/* تخصيص شاشة الانتظار */
#loadingModal .modal-content {
border-radius: 15px;
background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
}

#loadingModal .spinner-border {
border-width: 4px;
}

.progress-bar {
background: linear-gradient(90deg, #007bff, #6610f2);
}

/* تأثيرات إضافية للشاشة */
.loading-spinner {
position: relative;
}



@keyframes pulse {
0% {
    transform: scale(1);
    opacity: 1;
}
50% {
    transform: scale(1.1);
    opacity: 0.7;
}
100% {
    transform: scale(1);
    opacity: 1;
}
}

/* تأثيرات للزر */
#submit-btn:disabled {
opacity: 0.7;
cursor: not-allowed;
}
</style>
{% endblock %}